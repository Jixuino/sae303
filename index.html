<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SAE303 PIERRE FRENZEL & AELIS PONTET-BRUN</title>
    
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script>
      // =================================================================
      // GESTION DU POPUP CRÉDITS (NOUVEAU)
      // =================================================================
      AFRAME.registerComponent('credits-handler', {
        init: function() {
            const btn = this.el;
            const popup = document.querySelector('#popup-credits');
            const closeBtn = document.querySelector('#btn-close-credits');

            // Ouvrir le popup
            btn.addEventListener('click', () => {
                popup.setAttribute('visible', true);
                document.querySelector('#btn-close-credits-plane').classList.add('clickable');
            });

            // Fermer le popup
            closeBtn.addEventListener('click', () => {
                popup.setAttribute('visible', false);
                document.querySelector('#btn-close-credits-plane').classList.remove('clickable');
            });
        }
      });

      // =================================================================
      // 1. GÉNÉRATEUR DE POPULATION (SCÈNE 2) - INCHANGÉ
      // =================================================================
      AFRAME.registerComponent('population-generator', {
        schema: {
          count: {type: 'int', default: 10},
          zStart: {type: 'number', default: 0},
          zEnd: {type: 'number', default: -10},
          widthSpread: {type: 'number', default: 10},
          modelScale: {type: 'vec3', default: {x: 1, y: 1, z: 1}} 
        },
        init: function() {
          let data = this.data;
          for (let i = 0; i < data.count; i++) {
            let avatar = document.createElement('a-entity');
            let posX = (Math.random() - 0.5) * data.widthSpread;
            let posZ = data.zStart + Math.random() * (data.zEnd - data.zStart);
            
            avatar.setAttribute('position', {x: posX, y: 0, z: posZ});
            avatar.setAttribute('gltf-model', '#student-model'); 
            avatar.setAttribute('scale', data.modelScale);
            
            let randomRot = Math.random() * 360;
            avatar.setAttribute('rotation', {x: 0, y: randomRot, z: 0});
            
            this.el.appendChild(avatar);
          }
        }
      });

      // =================================================================
      // 2. LA FORÊT DES FORMATIONS (SCÈNE 3) - INCHANGÉ
      // =================================================================
      AFRAME.registerComponent('forest-manager', {
        init: function() {
            const container = this.el;

            const zones = [
                { 
                    count: 48, model: '#arbre', scale: '0.2 0.2 0.2', color: '#4CAF50', 
                    xPos: -8, yPos: 0, width: 5, height: 15, 
                    label: "Niveau 5\n(48 Formations)"
                },
                { 
                    count: 37, model: '#arbre', scale: '0.4 0.4 0.4', color: '#FF9800', 
                    xPos: 8, yPos: 0, width: 5, height: 15, 
                    label: "Niveau 6\n(37 Formations)"
                },
                { 
                    count: 5, model: '#arbre', scale: '0.6 0.6 0.6', color: '#9C27B0', 
                    xPos: 0, yPos: 0, width: 5, height: 15, 
                    label: "Niveau 7\n(5 Formations)"
                }
            ];

            zones.forEach(zone => {
                let text = document.createElement('a-text');
                text.setAttribute('value', zone.label);
                text.setAttribute('align', 'center');
                text.setAttribute('color', zone.color);
                text.setAttribute('scale', '5 5 5');
                text.setAttribute('position', {x: zone.xPos, y: 15, z: 2}); 
                container.appendChild(text);

                let placedTrees = []; 
                let scaleVal = parseFloat(zone.scale.split(' ')[0]);
                let minDistance = 0;

                if (scaleVal >= 1) minDistance = 2.5;      
                else if (scaleVal >= 0.6) minDistance = 1.2; 
                else minDistance = 0.1;                    

                for(let i=0; i<zone.count; i++) {
                    let tree = document.createElement('a-entity');
                    let px, py;
                    let validPosition = false;
                    let attempts = 0;
                    let maxAttempts = 50; 

                    while (!validPosition && attempts < maxAttempts) {
                        px = zone.xPos + (Math.random() - 0.5) * zone.width;
                        py = zone.yPos + (Math.random() - 0.5) * zone.height;

                        let collision = false;
                        if (minDistance > 0.2) { 
                            for (let pos of placedTrees) {
                                let dx = px - pos.x;
                                let dy = py - pos.y;
                                let distance = Math.sqrt(dx*dx + dy*dy);
                                if (distance < minDistance) {
                                    collision = true;
                                    break;
                                }
                            }
                        }
                        if (!collision) validPosition = true;
                        attempts++;
                    }
                    placedTrees.push({x: px, y: py});

                    tree.setAttribute('position', {x: px, y: py, z: 0});
                    tree.setAttribute('gltf-model', zone.model);
                    tree.setAttribute('scale', zone.scale);
                    tree.setAttribute('rotation', {x: 90, y: 0, z: 0});

                    container.appendChild(tree);
                }
            });
        }
      });

      // =================================================================
      // 3. LA MARÉE HUMAINE (SCÈNE 4) - INCHANGÉ
      // =================================================================
      AFRAME.registerComponent('tide-manager', {
        init: function() {
            this.totalVisuals = 100; 
            this.visuals = []; 
            this.container = this.el;
            this.infoText = document.querySelector('#s4-info-text');

            this.diplomas = [
                {id: "btn-dip-en", label: "Diplome EN", count: 2665, color: "#2196F3"}, 
                {id: "btn-dip-etat", label: "Diplome Etat", count: 453, color: "#F44336"}, 
                {id: "btn-rncp", label: "Titre RNCP", count: 379, color: "#4CAF50"}, 
                {id: "btn-certif", label: "Certificat", count: 98, color: "#FFEB3B"}, 
                {id: "btn-certif-pro", label: "Certificat Pro", count: 68, color: "#FF9800"}, 
                {id: "btn-titre-pro", label: "Titre Pro", count: 12, color: "#9C27B0"} 
            ];
            
            const totalRealStudents = 3675;

            for(let i=0; i<this.totalVisuals; i++) {
                let ent = document.createElement('a-entity');
                ent.setAttribute('gltf-model', '#student'); 
                ent.setAttribute('scale', '10 10 10'); 
                
                let startX = -11 + Math.random() * 5; 
                let startY = -7 + Math.random() * 14; 
                
                ent.setAttribute('position', {x: startX, y: startY, z: 0});
                ent.setAttribute('rotation', {x: 90, y: 0, z: 0}); 

                ent.userData = { restX: startX, restY: startY };
                
                this.container.appendChild(ent);
                this.visuals.push(ent);
            }

            this.diplomas.forEach(dip => {
                let btn = document.querySelector(`#${dip.id}`);
                if(btn) {
                    btn.addEventListener('click', () => {
                        this.activateTide(dip, totalRealStudents);
                    });
                }
            });
        },

        activateTide: function(diplomaData, total) {
            let ratio = diplomaData.count / total;
            let numToMove = Math.round(ratio * this.totalVisuals);
            if(diplomaData.count > 0 && numToMove === 0) numToMove = 1;

            let percent = (ratio * 100).toFixed(1);
            this.infoText.setAttribute('value', `${diplomaData.label}\n${diplomaData.count} Etudiants\n(${percent}%)`);
            this.infoText.setAttribute('color', diplomaData.color);

            this.visuals.forEach((ent, index) => {
                if (index < numToMove) {
                    let targetX = 6 + Math.random() * 5; 
                    let targetY = -7 + Math.random() * 14; 

                    ent.setAttribute('animation', `property: position; to: ${targetX} ${targetY} 0; dur: 1500; easing: easeInOutQuad`);
                    ent.setAttribute('scale', '12 12 12'); 
                } else {
                    ent.setAttribute('animation', `property: position; to: ${ent.userData.restX} ${ent.userData.restY} 0; dur: 1500; easing: easeInOutQuad`);
                    ent.setAttribute('scale', '10 10 10');
                }
            });
        }
      });

      // =================================================================
      // 4. CONTRÔLEUR GLOBAL - INCHANGÉ
      // =================================================================
      AFRAME.registerComponent('app-controller', {
        init: function () {
          this.menuGroup = document.querySelector('#main-menu');
          this.scene2Group = document.querySelector('#scene2-container');
          this.scene3Group = document.querySelector('#scene3-container');
          this.scene4Group = document.querySelector('#scene4-container');
          this.popupCredits = document.querySelector('#popup-credits');
          
          this.scene2Step = 1; 
          
          document.querySelector('#btn-launch-scene2').addEventListener('click', () => { this.openScene(2); });
          document.querySelector('#btn-launch-scene3').addEventListener('click', () => { this.openScene(3); });
          document.querySelector('#btn-launch-scene4').addEventListener('click', () => { this.openScene(4); });

          this.year2015 = document.querySelector('#year-2015');
          this.year2020 = document.querySelector('#year-2020');
          this.year2025 = document.querySelector('#year-2025');
          this.s2BtnPrev = document.querySelector('#s2-btn-prev');
          this.s2BtnNext = document.querySelector('#s2-btn-next');
          
          this.s2BtnNext.addEventListener('click', () => { if(this.scene2Step < 3) this.goToYear(this.scene2Step + 1); });
          this.s2BtnPrev.addEventListener('click', () => { if(this.scene2Step > 1) this.goToYear(this.scene2Step - 1); });
          document.querySelector('#s2-btn-close').addEventListener('click', () => { this.openMenu(); });

          document.querySelector('#s3-btn-close').addEventListener('click', () => { this.openMenu(); });
          document.querySelector('#s4-btn-close').addEventListener('click', () => { this.openMenu(); });
        },

        openMenu: function() {
            this.menuGroup.setAttribute('visible', true);
            this.scene2Group.setAttribute('visible', false);
            this.scene3Group.setAttribute('visible', false);
            this.scene4Group.setAttribute('visible', false);
            this.popupCredits.setAttribute('visible', false);
            
            this.toggleClickable('.menu-item', true);
            this.toggleClickable('.scene2-ui', false);
            this.toggleClickable('.scene3-ui', false);
            this.toggleClickable('.scene4-ui', false);
            this.toggleClickable('.popup-ui', false);
        },

        openScene: function(sceneId) {
            this.menuGroup.setAttribute('visible', false);
            this.toggleClickable('.menu-item', false);

            if (sceneId === 2) {
                this.scene2Group.setAttribute('visible', true);
                this.toggleClickable('.scene2-ui', true);
                this.goToYear(1); 
            } 
            else if (sceneId === 3) {
                this.scene3Group.setAttribute('visible', true);
                this.toggleClickable('.scene3-ui', true);
            }
            else if (sceneId === 4) {
                this.scene4Group.setAttribute('visible', true);
                this.toggleClickable('.scene4-ui', true);
            }
        },

        goToYear: function(step) {
          this.scene2Step = step;
          this.year2015.setAttribute('visible', false);
          this.year2020.setAttribute('visible', false);
          this.year2025.setAttribute('visible', false);

          if (step === 1) this.year2015.setAttribute('visible', true);
          if (step === 2) this.year2020.setAttribute('visible', true);
          if (step === 3) this.year2025.setAttribute('visible', true);

          if (step === 1) { this.s2BtnPrev.setAttribute('visible', false); this.s2BtnPrev.classList.remove('clickable'); }
          else { this.s2BtnPrev.setAttribute('visible', true); this.s2BtnPrev.classList.add('clickable'); }

          if (step === 3) { this.s2BtnNext.setAttribute('visible', false); this.s2BtnNext.classList.remove('clickable'); }
          else { this.s2BtnNext.setAttribute('visible', true); this.s2BtnNext.classList.add('clickable'); }
        },

        toggleClickable: function(className, isClickable) {
          let els = document.querySelectorAll(className);
          els.forEach(el => {
            if(isClickable) el.classList.add('clickable');
            else el.classList.remove('clickable');
          });
        }
      });

      AFRAME.registerComponent('navigate-on-click', {
        schema: { url: {default: ''} },
        init: function () {
          var data = this.data;
          this.el.addEventListener('click', function () { window.location.href = data.url; });
        }
      });
    </script>
  </head>
  <body>
    <a-scene app-controller mindar-image="imageTargetSrc: affiche.mind;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <img id="affiche" src="main_scene/affiche_fond.png" />
        <img id="crédits" src="main_scene/crédits.png" />
        <img id="batiments" src="main_scene/batiments.png" />
        <img id="niveau2formation" src="main_scene/niveau2formation.png" />
        <img id="evolutionApprentis" src="main_scene/evolutionApprentis.png" />
        <img id="type2diplome" src="main_scene/type2diplome.png" />
        <img id="lesFormations" src="main_scene/lesFormations.png" />
        
        <a-asset-item id="student-model" src="assets_scene2/mjo_character_student_school.glb"></a-asset-item>
        <a-asset-item id="arbre" src="assets_scene3/arbre.glb"></a-asset-item>
        <a-asset-item id="student" src="assets_scene4/student.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 100000; objects: .clickable"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        
        <a-entity id="main-menu">
            <a-plane src="#affiche" position="0 0 0" height="1.552" width="1" rotation="0 0 0"></a-plane>

            <a-image id="btn-credits" class="clickable menu-item" src="#crédits" 
                     credits-handler
                     position="0.38 0.55 0.02" scale="0.18 0.18 1"
                     animation="property: scale; to: 0.23 0.23 1; dur: 1000; dir: alternate; loop: true">
            </a-image>

            <a-image class="clickable menu-item" src="#lesFormations" navigate-on-click="url: scene1.html"
                     position="-0.25 0.25 0.01" scale="0.45 0.25 1"
                     animation="property: scale; to: 0.50 0.28 1; dur: 1000; dir: alternate; loop: true">
            </a-image>

            

            <a-image src="#batiments" 
                     position="0.30 0.20 0.01" scale="0.38 0.33 1"
                     animation="property: scale; to: 0.42 0.36 1; dur: 1000; dir: alternate; loop: true">
            </a-image>

            
            <a-image  id="btn-launch-scene2" class="clickable menu-item" src="#evolutionApprentis" 
                     position="0.3 -0.17 0.01" scale="0.30 0.20 1"
                     animation="property: scale; to: 0.35 0.24 1; dur: 1000; dir: alternate; loop: true">
            </a-image>

            <a-image id="btn-launch-scene3" class="clickable menu-item" src="#niveau2formation" 
                     position="-0.24 -0.44 0.01" scale="0.18 0.18 1"
                     animation="property: scale; to: 0.22 0.22 1; dur: 1000; dir: alternate; loop: true">
            </a-image>

            <a-image id="btn-launch-scene4" class="clickable menu-item" src="#type2diplome"
                     position="0.3 -0.435 0.01" scale="0.25 0.25 1"
                     animation="property: scale; to: 0.30 0.30 1; dur: 1000; dir: alternate; loop: true">
            </a-image>
        </a-entity>

        <a-entity id="popup-credits" visible="false" position="0 0 0.2">
            <a-plane color="#000" opacity="0.9" width="0.9" height="0.6"></a-plane>
            
            <a-text value="Realise par\nPIERRE FRENZEL\n&\nAELIS PONTET-BRUN" 
                    align="center" position="0 0.1 0.01" scale="0.2 0.2 0.2"></a-text>
            <a-text value="ETUDIANTS BUT MMI\n2EME ANNEE" 
                    align="center" position="0 -0.1 0.01" color="#4CC3D9" scale="0.2 0.2 0.2"></a-text>

            <a-entity id="btn-close-credits" position="0 -0.2 0.01">
                <a-plane id="btn-close-credits-plane" class="popup-ui" color="#D7263D" width="0.3" height="0.1"></a-plane>
                <a-text value="FERMER" align="center" scale="0.2 0.2 0.2" position="0 0 0.01"></a-text>
            </a-entity>
        </a-entity>


        <a-entity id="scene2-container" visible="false" scale="0.05 0.05 0.05" rotation="0 0 0">
            <a-plane width="30" height="40" color="#111" position="0 5 -5"></a-plane>

            <a-entity id="year-2015" visible="false">
                <a-entity position="0 1 0" population-generator="count: 15; zStart: 0; zEnd: -10; widthSpread: 10; modelScale: 0.1 0.1 0.1" rotation="90 0 0"></a-entity>
                <a-text value="2015" position="0 -3 1" align="center" color="#FFF" scale="8 8 8"></a-text>
                <a-text value="78 Apprentis" position="0 -5 1" align="center" color="#aaa" scale="4 4 4"></a-text>
            </a-entity>

            <a-entity id="year-2020" visible="false">
                <a-entity position="0 1 0" population-generator="count: 60; zStart: 0; zEnd: -15; widthSpread: 12; modelScale: 0.1 0.1 0.1" rotation="90 0 0"></a-entity>
                <a-text value="2020" position="0 -3 1" align="center" color="#FFF" scale="8 8 8"></a-text>
                <a-text value="153 Apprentis" position="0 -5 1" align="center" color="#aaa" scale="4 4 4"></a-text>
            </a-entity>

            <a-entity id="year-2025" visible="false">
                <a-entity position="0 1 0" population-generator="count: 200; zStart: 0; zEnd: -20; widthSpread: 20; modelScale: 0.1 0.1 0.1" rotation="90 0 0"></a-entity>
                <a-text value="2025" position="0 -3 1" align="center" color="#F00" scale="10 10 10"></a-text>
                <a-text value="928 APPRENTIS !" position="0 -5 1" align="center" color="#F00" scale="5 5 5"></a-text>
            </a-entity>

            <a-plane id="s2-btn-prev" class="scene2-ui" position="-8 -10 2" width="5" height="2.5" color="#333">
                <a-text value="< RETOUR" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="s2-btn-next" class="scene2-ui" position="8 -10 2" width="5" height="2.5" color="#4CC3D9">
                <a-text value="SUIVANT >" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="s2-btn-close" class="scene2-ui" position="0 -10 2" width="6" height="2" color="#D7263D">
                <a-text value="Affiche" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
        </a-entity>

        <a-entity id="scene3-container" visible="false" scale="0.05 0.05 0.05" rotation="0 0 0">
            <a-plane width="30" height="40" color="#1a237e" position="0 5 -5"></a-plane>
            <a-text value="LA FORET DES FORMATIONS" position="0 18 1" align="center" color="#FFF" scale="6 6 6"></a-text>
            
            <a-entity position="0 0 0" forest-manager></a-entity>

            <a-plane id="s3-btn-close" class="scene3-ui" position="0 -10 2" width="6" height="2" color="#D7263D">
                <a-text value="Affiche" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
        </a-entity>

        <a-entity id="scene4-container" visible="false" scale="0.05 0.05 0.05" rotation="0 0 0">
            <a-plane width="30" height="40" color="#ddd" position="0 5 -5"></a-plane>
            <a-text value="REPARTITION PAR DIPLOME" position="0 20 1" align="center" color="#333" scale="5.5 5.5 5.5"></a-text>

            <a-entity position="0 6.5 0" tide-manager></a-entity>

            <a-text id="s4-info-text" value="Cliquez sur un diplome" position="0 17 1" align="center" color="#333" scale="6 6 6"></a-text>

            <a-plane id="btn-dip-en" class="scene4-ui" position="-10 -4 2" width="8" height="2" color="#2196F3">
                <a-text value="Diplome EN" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="btn-dip-etat" class="scene4-ui" position="0 -4 2" width="8" height="2" color="#F44336">
                <a-text value="Diplome Etat" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="btn-rncp" class="scene4-ui" position="10 -4 2" width="8" height="2" color="#4CAF50">
                <a-text value="Titre RNCP" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>

            <a-plane id="btn-certif" class="scene4-ui" position="-10 -8 2" width="8" height="2" color="#FFEB3B">
                <a-text value="Certificat" align="center" scale="3 3 3" position="0 0 0.1" color="black"></a-text>
            </a-plane>
            <a-plane id="btn-certif-pro" class="scene4-ui" position="0 -8 2" width="8" height="2" color="#FF9800">
                <a-text value="Certif Pro" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="btn-titre-pro" class="scene4-ui" position="10 -8 2" width="8" height="2" color="#9C27B0">
                <a-text value="Titre Pro" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>

            <a-plane id="s4-btn-close" class="scene4-ui" position="0 -12 2" width="6" height="2" color="#D7263D">
                <a-text value="Affiche" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
        </a-entity>

      </a-entity>
    </a-scene>
  </body>
</html>