<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>SAE303 PIERRE FRENZEL & AELIS PONTET-BRUN</title>
    
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script>
      // =================================================================
      // 1. GÉNÉRATEUR DE POPULATION (SCÈNE 2)
      // =================================================================
      AFRAME.registerComponent('population-generator', {
        schema: {
          count: {type: 'int', default: 10},
          zStart: {type: 'number', default: 0},
          zEnd: {type: 'number', default: -10},
          widthSpread: {type: 'number', default: 10},
          modelScale: {type: 'vec3', default: {x: 1, y: 1, z: 1}} 
        },
        init: function() {
          let data = this.data;
          for (let i = 0; i < data.count; i++) {
            let avatar = document.createElement('a-entity');
            let posX = (Math.random() - 0.5) * data.widthSpread;
            let posZ = data.zStart + Math.random() * (data.zEnd - data.zStart);
            avatar.setAttribute('position', {x: posX, y: 0, z: posZ});
            avatar.setAttribute('gltf-model', '#student-model'); 
            avatar.setAttribute('scale', data.modelScale);
            let randomRot = Math.random() * 360;
            avatar.setAttribute('rotation', {x: 0, y: randomRot, z: 0});
            this.el.appendChild(avatar);
          }
        }
      });

      // =================================================================
      // 2. GESTIONNAIRE DU PUZZLE (SCÈNE 3)
      // =================================================================
      AFRAME.registerComponent('puzzle-manager', {
        init: function() {
            const filieres = [
                {name: "Medical", count: 1156, color: "#4cc3d9"},
                {name: "Commerce", count: 940, color: "#FFC65D"},
                {name: "Numerique", count: 484, color: "#7BC8A4"},
                {name: "Lettres", count: 450, color: "#EF2D5E"},
                {name: "Industrie", count: 295, color: "#24CAFF"},
                {name: "Gestion", count: 248, color: "#E6E6E6"},
                {name: "Tourisme", count: 76, color: "#F16745"},
                {name: "Art", count: 17, color: "#D7263D"},
                {name: "Logistique", count: 9, color: "#8E44AD"}
            ];
            const totalStudents = 3675;
            const container = this.el;
            const positions = [
                {x: -8, y: 10}, {x: 0, y: 10}, {x: 8, y: 10},
                {x: -8, y: 2},  {x: 0, y: 2},  {x: 8, y: 2},
                {x: -8, y: -6}, {x: 0, y: -6}, {x: 8, y: -6}
            ];

            filieres.forEach((f, index) => {
                let percent = ((f.count / totalStudents) * 100).toFixed(1);
                let sizeFactor = Math.sqrt(f.count) / 10; 
                if(sizeFactor < 0.6) sizeFactor = 0.6;
                if(sizeFactor > 2.5) sizeFactor = 2.5;

                let box = document.createElement('a-box');
                let targetPos = positions[index];
                
                let startX = (Math.random() - 0.5) * 60;
                let startY = (Math.random() - 0.5) * 60;
                let startZ = 20 + Math.random() * 20;

                box.setAttribute('position', {x: startX, y: startY, z: startZ});
                box.setAttribute('color', f.color);
                box.setAttribute('depth', 2);
                box.setAttribute('width', 4.5); 
                box.setAttribute('height', 4.5);
                box.setAttribute('scale', {x: sizeFactor, y: sizeFactor, z: 1});

                let delay = index * 100;
                box.setAttribute('animation', `property: position; to: ${targetPos.x} ${targetPos.y} 0; dur: 1500; easing: easeOutElastic; delay: ${delay}`);

                box.classList.add('scene3-piece'); 

                let text = document.createElement('a-text');
                text.setAttribute('value', `${f.name}\n${f.count} (${percent}%)`);
                text.setAttribute('align', 'center');
                text.setAttribute('position', '0 0 3'); 
                text.setAttribute('scale', {x: 2.5/sizeFactor, y: 2.5/sizeFactor, z: 1}); 
                text.setAttribute('visible', false);
                box.appendChild(text);

                box.addEventListener('click', function() {
                    document.querySelectorAll('.scene3-piece').forEach(el => {
                        el.setAttribute('material', 'opacity', 0.4); 
                        el.querySelector('a-text').setAttribute('visible', false);
                    });
                    this.setAttribute('material', 'opacity', 1);
                    text.setAttribute('visible', true);
                    this.setAttribute('animation__pop', 'property: position; dir: alternate; dur: 200; to: ' + targetPos.x + ' ' + targetPos.y + ' 2; loop: 1');
                });
                container.appendChild(box);
            });
        }
      });

      // =================================================================
      // 3. LA MARÉE HUMAINE (SCÈNE 4) - CORRIGÉ
      // =================================================================
      AFRAME.registerComponent('tide-manager', {
        init: function() {
            this.totalVisuals = 100; 
            this.visuals = []; 
            this.container = this.el;
            this.infoText = document.querySelector('#s4-info-text');

            this.diplomas = [
                {id: "btn-dip-en", label: "Diplome EN", count: 2665, color: "#2196F3"}, 
                {id: "btn-dip-etat", label: "Diplome Etat", count: 453, color: "#F44336"}, 
                {id: "btn-rncp", label: "Titre RNCP", count: 379, color: "#4CAF50"}, 
                {id: "btn-certif", label: "Certificat", count: 98, color: "#FFEB3B"}, 
                {id: "btn-certif-pro", label: "Certificat Pro", count: 68, color: "#FF9800"}, 
                {id: "btn-titre-pro", label: "Titre Pro", count: 12, color: "#9C27B0"} 
            ];
            
            const totalRealStudents = 3675;

            // --- CRÉATION DE LA FOULE ---
            for(let i=0; i<this.totalVisuals; i++) {
                let ent = document.createElement('a-entity');
                
                ent.setAttribute('gltf-model', '#student'); 
                
                // CORRECTION IMPORTANTE : L'ÉCHELLE
                // Le container parent est déjà à 0.05.

                ent.setAttribute('scale', '10 10 10'); 
                
                // Position aléatoire Gauche
                let startX = -12 + Math.random() * 8; 
                let startZ = -10 + Math.random() * 20;
                
                ent.setAttribute('position', {x: startX, y: 0, z: startZ});
                
                // CORRECTION ROTATION : Si le modèle est couché, il faut peut-être x:90 ou x:0
                // J'essaie une rotation standard debout.
                ent.setAttribute('rotation', {x: 0, y: 0, z: 0}); 

                ent.userData = { restX: startX, restZ: startZ };
                
                this.container.appendChild(ent);
                this.visuals.push(ent);
            }

            // --- LISTENERS ---
            this.diplomas.forEach(dip => {
                let btn = document.querySelector(`#${dip.id}`);
                if(btn) {
                    btn.addEventListener('click', () => {
                        this.activateTide(dip, totalRealStudents);
                    });
                }
            });
        },

        activateTide: function(diplomaData, total) {
            let ratio = diplomaData.count / total;
            let numToMove = Math.round(ratio * this.totalVisuals);
            if(diplomaData.count > 0 && numToMove === 0) numToMove = 1;

            // Update Texte
            let percent = (ratio * 100).toFixed(1);
            this.infoText.setAttribute('value', `${diplomaData.label}\n${diplomaData.count} Etudiants\n(${percent}%)`);
            this.infoText.setAttribute('color', diplomaData.color);

            // Animation
            this.visuals.forEach((ent, index) => {
                if (index < numToMove) {
                    // Mouvement vers Droite
                    let targetX = 4 + Math.random() * 8;
                    let targetZ = -10 + Math.random() * 20;

                    ent.setAttribute('animation', `property: position; to: ${targetX} 0 ${targetZ}; dur: 1500; easing: easeInOutQuad`);
                    
                    // Effet de sélection (Grossit un peu)
                    ent.setAttribute('scale', '10 10 10'); 
                } else {
                    // Retour Gauche
                    ent.setAttribute('animation', `property: position; to: ${ent.userData.restX} 0 ${ent.userData.restZ}; dur: 1500; easing: easeInOutQuad`);
                    ent.setAttribute('scale', '10 10 10');
                }
            });
        }
      });

      // =================================================================
      // 4. CONTRÔLEUR GLOBAL
      // =================================================================
      AFRAME.registerComponent('app-controller', {
        init: function () {
          this.menuGroup = document.querySelector('#main-menu');
          this.scene2Group = document.querySelector('#scene2-container');
          this.scene3Group = document.querySelector('#scene3-container');
          this.scene4Group = document.querySelector('#scene4-container');
          
          this.scene2Step = 1; 
          
          // Menu Principal
          document.querySelector('#btn-launch-scene2').addEventListener('click', () => { this.openScene(2); });
          document.querySelector('#btn-launch-scene3').addEventListener('click', () => { this.openScene(3); });
          document.querySelector('#btn-launch-scene4').addEventListener('click', () => { this.openScene(4); });

          // Scene 2
          this.year2015 = document.querySelector('#year-2015');
          this.year2020 = document.querySelector('#year-2020');
          this.year2025 = document.querySelector('#year-2025');
          this.s2BtnPrev = document.querySelector('#s2-btn-prev');
          this.s2BtnNext = document.querySelector('#s2-btn-next');
          
          this.s2BtnNext.addEventListener('click', () => { if(this.scene2Step < 3) this.goToYear(this.scene2Step + 1); });
          this.s2BtnPrev.addEventListener('click', () => { if(this.scene2Step > 1) this.goToYear(this.scene2Step - 1); });
          document.querySelector('#s2-btn-close').addEventListener('click', () => { this.openMenu(); });

          // Scene 3 & 4
          document.querySelector('#s3-btn-close').addEventListener('click', () => { this.openMenu(); });
          document.querySelector('#s4-btn-close').addEventListener('click', () => { this.openMenu(); });
        },

        openMenu: function() {
            this.menuGroup.setAttribute('visible', true);
            this.scene2Group.setAttribute('visible', false);
            this.scene3Group.setAttribute('visible', false);
            this.scene4Group.setAttribute('visible', false);
            
            this.toggleClickable('.menu-item', true);
            this.toggleClickable('.scene2-ui', false);
            this.toggleClickable('.scene3-piece', false); 
            this.toggleClickable('.scene3-ui', false);
            this.toggleClickable('.scene4-ui', false);
        },

        openScene: function(sceneId) {
            this.menuGroup.setAttribute('visible', false);
            this.toggleClickable('.menu-item', false);

            if (sceneId === 2) {
                this.scene2Group.setAttribute('visible', true);
                this.toggleClickable('.scene2-ui', true);
                this.goToYear(1); 
            } 
            else if (sceneId === 3) {
                this.scene3Group.setAttribute('visible', true);
                this.toggleClickable('.scene3-ui', true);
                this.toggleClickable('.scene3-piece', true);
            }
            else if (sceneId === 4) {
                this.scene4Group.setAttribute('visible', true);
                this.toggleClickable('.scene4-ui', true);
            }
        },

        goToYear: function(step) {
          this.scene2Step = step;
          this.year2015.setAttribute('visible', false);
          this.year2020.setAttribute('visible', false);
          this.year2025.setAttribute('visible', false);

          if (step === 1) this.year2015.setAttribute('visible', true);
          if (step === 2) this.year2020.setAttribute('visible', true);
          if (step === 3) this.year2025.setAttribute('visible', true);

          if (step === 1) { this.s2BtnPrev.setAttribute('visible', false); this.s2BtnPrev.classList.remove('clickable'); }
          else { this.s2BtnPrev.setAttribute('visible', true); this.s2BtnPrev.classList.add('clickable'); }

          if (step === 3) { this.s2BtnNext.setAttribute('visible', false); this.s2BtnNext.classList.remove('clickable'); }
          else { this.s2BtnNext.setAttribute('visible', true); this.s2BtnNext.classList.add('clickable'); }
        },

        toggleClickable: function(className, isClickable) {
          let els = document.querySelectorAll(className);
          els.forEach(el => {
            if(isClickable) el.classList.add('clickable');
            else el.classList.remove('clickable');
          });
        }
      });

      // --- 5. NAVIGATION HTML ---
      AFRAME.registerComponent('navigate-on-click', {
        schema: { url: {default: ''} },
        init: function () {
          var data = this.data;
          this.el.addEventListener('click', function () { window.location.href = data.url; });
        }
      });
    </script>
  </head>
  <body>
    <a-scene app-controller mindar-image="imageTargetSrc: affiche.mind;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <img id="affiche" src="main_scene/sans_elements.png" />
        <img id="scene1-img" src="main_scene/etudiant.png" />
        <img id="scene2-img" src="main_scene/etablissement.png" />
        <img id="scene3-img" src="main_scene/camembert.png" />
        <img id="scene-4-img" src="main_scene/homme_porte.png" />
        <a-asset-item id="student-model" src="assets_scene2/mjo_character_student_school.glb"></a-asset-item>
        
        <a-asset-item id="student" src="assets_scene4/student.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 100000; objects: .clickable"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        
        <a-entity id="main-menu">
            <a-plane src="#affiche" position="0 0 0" height="1.552" width="1" rotation="0 0 0"></a-plane>
            
            <a-image class="clickable menu-item" src="#scene1-img" navigate-on-click="url: scene1.html"
                     position="-0.35 0 0.1" scale="0.25 0.25 0.25"
                     animation="property: position; to: -0.35 0.1 0.1; dur: 1000; dir: alternate; loop: true"></a-image>

            <a-image id="btn-launch-scene2" class="clickable menu-item" src="#scene2-img" 
                     position="0 0 0.1" scale="0.25 0.25 0.25"
                     animation="property: position; to: 0 0.1 0.1; dur: 1000; dir: alternate; loop: true"></a-image>

            <a-image id="btn-launch-scene3" class="clickable menu-item" src="#scene3-img" 
                     position="0.35 0 0.1" scale="0.25 0.25 0.25"
                     animation="property: position; to: 0.35 0.1 0.1; dur: 1000; dir: alternate; loop: true"></a-image>

            <a-image id="btn-launch-scene4" class="clickable menu-item" src="#scene-4-img" 
                     position="0.7 0 0.1" scale="0.25 0.25 0.25"
                     animation="property: position; to: 0.7 0.1 0.1; dur: 1000; dir: alternate; loop: true"></a-image>
        </a-entity>


        <a-entity id="scene2-container" visible="false" scale="0.05 0.05 0.05" rotation="0 0 0">
            <a-plane width="30" height="40" color="#111" position="0 5 -5"></a-plane>

            <a-entity id="year-2015" visible="false">
                <a-entity position="0 1 0" population-generator="count: 15; zStart: 0; zEnd: -10; widthSpread: 10; modelScale: 0.1 0.1 0.1" rotation="90 0 0"></a-entity>
                <a-text value="2015" position="0 -3 1" align="center" color="#FFF" scale="8 8 8"></a-text>
                <a-text value="78 Apprentis" position="0 -5 1" align="center" color="#aaa" scale="4 4 4"></a-text>
            </a-entity>

            <a-entity id="year-2020" visible="false">
                <a-entity position="0 1 0" population-generator="count: 60; zStart: 0; zEnd: -15; widthSpread: 12; modelScale: 0.1 0.1 0.1" rotation="90 0 0"></a-entity>
                <a-text value="2020" position="0 -3 1" align="center" color="#FFF" scale="8 8 8"></a-text>
                <a-text value="153 Apprentis" position="0 -5 1" align="center" color="#aaa" scale="4 4 4"></a-text>
            </a-entity>

            <a-entity id="year-2025" visible="false">
                <a-entity position="0 1 0" population-generator="count: 200; zStart: 0; zEnd: -20; widthSpread: 20; modelScale: 0.1 0.1 0.1" rotation="90 0 0"></a-entity>
                <a-text value="2025" position="0 -3 1" align="center" color="#F00" scale="10 10 10"></a-text>
                <a-text value="928 APPRENTIS !" position="0 -5 1" align="center" color="#F00" scale="5 5 5"></a-text>
            </a-entity>

            <a-plane id="s2-btn-prev" class="scene2-ui" position="-8 -10 2" width="5" height="2.5" color="#333">
                <a-text value="< RETOUR" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="s2-btn-next" class="scene2-ui" position="8 -10 2" width="5" height="2.5" color="#4CC3D9">
                <a-text value="SUIVANT >" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="s2-btn-close" class="scene2-ui" position="0 -10 2" width="6" height="2" color="#D7263D">
                <a-text value="Affiche" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
        </a-entity>


        <a-entity id="scene3-container" visible="false" scale="0.05 0.05 0.05" rotation="0 0 0">
            <a-plane width="30" height="40" color="#2c3e50" position="0 5 -5"></a-plane>
            <a-text value="Le Puzzle des Filieres" position="0 15 1" align="center" color="#FFF" scale="6 6 6"></a-text>
            
            <a-entity position="0 4 0" puzzle-manager></a-entity>

            <a-plane id="s3-btn-close" class="scene3-ui" position="0 -10 2" width="6" height="2" color="#D7263D">
                <a-text value="Affiche" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
        </a-entity>


        <a-entity id="scene4-container" visible="false" scale="0.05 0.05 0.05" rotation="0 0 0">
            <a-plane width="30" height="40" color="#111111" position="0 5 -5"></a-plane>
            
            <a-text value="REPARTITION PAR DIPLOME" position="0 20 1" align="center" color="#0000" scale="6 6 6"></a-text>

            <a-entity position="0 5 0" tide-manager></a-entity>

            <a-text id="s4-info-text" value="Cliquez sur un diplome" position="0 15 1" align="center" color="#0000" scale="8 8 8"></a-text>

            <a-plane id="btn-dip-en" class="scene4-ui" position="-10 -2 2" width="8" height="2" color="#2196F3">
                <a-text value="Diplome EN" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="btn-dip-etat" class="scene4-ui" position="0 -2 2" width="8" height="2" color="#F44336">
                <a-text value="Diplome Etat" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="btn-rncp" class="scene4-ui" position="10 -2 2" width="8" height="2" color="#4CAF50">
                <a-text value="Titre RNCP" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>

            <a-plane id="btn-certif" class="scene4-ui" position="-10 -5 2" width="8" height="2" color="#FFEB3B">
                <a-text value="Certificat" align="center" scale="3 3 3" position="0 0 0.1" color="black"></a-text>
            </a-plane>
            <a-plane id="btn-certif-pro" class="scene4-ui" position="0 -5 2" width="8" height="2" color="#FF9800">
                <a-text value="Certif Pro" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="btn-titre-pro" class="scene4-ui" position="10 -5 2" width="8" height="2" color="#9C27B0">
                <a-text value="Titre Pro" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>

            <a-plane id="s4-btn-close" class="scene4-ui" position="0 -10 2" width="6" height="2" color="#D7263D">
                <a-text value="Affiche" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
        </a-entity>

      </a-entity>
    </a-scene>
  </body>
</html>