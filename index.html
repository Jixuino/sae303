<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Menu AR Interactif - Complet</title>
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>

    <script>
      // =================================================================
      // 1. GÉNÉRATEUR DE POPULATION (SCÈNE 2)
      // =================================================================
      AFRAME.registerComponent('population-generator', {
        schema: {
          count: {type: 'int', default: 10},
          zStart: {type: 'number', default: 0},
          zEnd: {type: 'number', default: -10},
          widthSpread: {type: 'number', default: 10},
          modelScale: {type: 'vec3', default: {x: 1, y: 1, z: 1}} 
        },
        init: function() {
          let data = this.data;
          for (let i = 0; i < data.count; i++) {
            let avatar = document.createElement('a-entity');
            let posX = (Math.random() - 0.5) * data.widthSpread;
            let posZ = data.zStart + Math.random() * (data.zEnd - data.zStart);
            avatar.setAttribute('position', {x: posX, y: 0, z: posZ});
            avatar.setAttribute('gltf-model', '#student-model');
            avatar.setAttribute('scale', data.modelScale);
            let randomRot = Math.random() * 360;
            avatar.setAttribute('rotation', {x: 0, y: randomRot, z: 0});
            this.el.appendChild(avatar);
          }
        }
      });

      // =================================================================
      // 2. GESTIONNAIRE DU PUZZLE (SCÈNE 3)
      // =================================================================
      AFRAME.registerComponent('puzzle-manager', {
        init: function() {
            // Données des filières (Nom, Effectif, Couleur)
            const filieres = [
                {name: "Medical", count: 1156, color: "#4cc3d9"},
                {name: "Commerce", count: 940, color: "#FFC65D"},
                {name: "Numerique", count: 484, color: "#7BC8A4"},
                {name: "Lettres", count: 450, color: "#EF2D5E"},
                {name: "Industrie", count: 295, color: "#24CAFF"},
                {name: "Gestion", count: 248, color: "#E6E6E6"},
                {name: "Tourisme", count: 76, color: "#F16745"},
                {name: "Art", count: 17, color: "#D7263D"},
                {name: "Logistique", count: 9, color: "#8E44AD"}
            ];

            const totalStudents = 3675;
            const container = this.el;

            // Grille 3x3 : Positions X et Y
            const positions = [
                {x: -6, y: 8}, {x: 0, y: 8}, {x: 6, y: 8},
                {x: -6, y: 2}, {x: 0, y: 2}, {x: 6, y: 2},
                {x: -6, y: -4}, {x: 0, y: -4}, {x: 6, y: -4}
            ];

            // Création des pièces
            filieres.forEach((f, index) => {
                // Calcul du pourcentage
                let percent = ((f.count / totalStudents) * 100).toFixed(1);
                
                // Calcul de la taille (Scale) basé sur l'effectif
                // On utilise la racine carrée pour éviter que le petit soit invisible
                let sizeFactor = Math.sqrt(f.count) / 10; 
                // Clamp pour éviter que ce soit trop petit ou trop gros
                if(sizeFactor < 0.5) sizeFactor = 0.5;
                if(sizeFactor > 3) sizeFactor = 3;

                // Création de l'entité Bloc
                let box = document.createElement('a-box');
                
                // Position finale (Grille)
                let targetPos = positions[index];
                
                // Position initiale (Aléatoire pour l'animation d'assemblage)
                let startX = (Math.random() - 0.5) * 50;
                let startY = (Math.random() - 0.5) * 50;
                let startZ = 20 + Math.random() * 20;

                box.setAttribute('position', {x: startX, y: startY, z: startZ});
                box.setAttribute('color', f.color);
                box.setAttribute('depth', 2);
                box.setAttribute('width', 5.5); // Largeur de case standard
                box.setAttribute('height', 5.5);
                
                // On applique l'échelle sur l'enfant visuel ou directement
                // Ici on triche : on scale tout le bloc pour montrer l'importance
                box.setAttribute('scale', {x: sizeFactor, y: sizeFactor, z: 1});

                // Animation d'entrée (Assemblage du puzzle)
                // "delay" varie pour qu'ils n'arrivent pas tous en même temps
                let delay = index * 100;
                box.setAttribute('animation', `property: position; to: ${targetPos.x} ${targetPos.y} 0; dur: 1500; easing: easeOutElastic; delay: ${delay}`);

                // --- INTERACTION ---
                box.classList.add('scene3-piece'); // Pour le raycaster

                // Texte (Info-bulle) caché par défaut
                let text = document.createElement('a-text');
                text.setAttribute('value', `${f.name}\n${f.count} (${percent}%)`);
                text.setAttribute('align', 'center');
                text.setAttribute('position', '0 0 1.1'); // Devant le bloc
                text.setAttribute('scale', {x: 2/sizeFactor, y: 2/sizeFactor, z: 1}); // Contre-balence le scale du parent
                text.setAttribute('visible', false);
                box.appendChild(text);

                // Événement Clic
                box.addEventListener('click', function() {
                    // Reset des autres pièces (optionnel, pour faire propre)
                    document.querySelectorAll('.scene3-piece').forEach(el => {
                        el.setAttribute('material', 'opacity', 0.5); // Assombrir les autres
                        el.querySelector('a-text').setAttribute('visible', false);
                    });

                    // Mise en avant de la pièce cliquée
                    this.setAttribute('material', 'opacity', 1);
                    text.setAttribute('visible', true);
                    
                    // Petite animation de "Pop"
                    this.setAttribute('animation__pop', 'property: position; dir: alternate; dur: 200; to: ' + targetPos.x + ' ' + targetPos.y + ' 2; loop: 1');
                });

                container.appendChild(box);
            });
        }
      });

      // =================================================================
      // 3. CONTRÔLEUR GLOBAL DE L'APPLICATION (MENU & NAVIGATION)
      // =================================================================
      AFRAME.registerComponent('app-controller', {
        init: function () {
          // --- ÉLÉMENTS ---
          this.menuGroup = document.querySelector('#main-menu');
          this.scene2Group = document.querySelector('#scene2-container');
          this.scene3Group = document.querySelector('#scene3-container');
          
          // --- ETAT INTERNE ---
          this.scene2Step = 0; 
          
          // --- BOUTONS MENU PRINCIPAL ---
          document.querySelector('#btn-launch-scene2').addEventListener('click', () => {
             this.openScene(2);
          });
          document.querySelector('#btn-launch-scene3').addEventListener('click', () => {
             this.openScene(3);
          });

          // --- LOGIQUE SCÈNE 2 (DIAPORAMA) ---
          this.year2015 = document.querySelector('#year-2015');
          this.year2020 = document.querySelector('#year-2020');
          this.year2025 = document.querySelector('#year-2025');
          this.s2BtnPrev = document.querySelector('#s2-btn-prev');
          this.s2BtnNext = document.querySelector('#s2-btn-next');
          
          // Listeners Scene 2
          this.s2BtnNext.addEventListener('click', () => { if(this.scene2Step < 3) this.goToYear(this.scene2Step + 1); });
          this.s2BtnPrev.addEventListener('click', () => { if(this.scene2Step > 1) this.goToYear(this.scene2Step - 1); });
          document.querySelector('#s2-btn-close').addEventListener('click', () => { this.openMenu(); });

          // --- LOGIQUE SCÈNE 3 (PUZZLE) ---
          document.querySelector('#s3-btn-close').addEventListener('click', () => { this.openMenu(); });
        },

        // --- FONCTIONS DE NAVIGATION ---
        
        openMenu: function() {
            // Affiche Menu, Cache Scènes
            this.menuGroup.setAttribute('visible', true);
            this.scene2Group.setAttribute('visible', false);
            this.scene3Group.setAttribute('visible', false);
            
            // Gestion Raycaster (Clics)
            this.toggleClickable('.menu-item', true);
            this.toggleClickable('.scene2-ui', false);
            this.toggleClickable('.scene3-piece', false); // Désactive les pièces du puzzle
            this.toggleClickable('.scene3-ui', false);

            this.scene2Step = 0;
        },

        openScene: function(sceneId) {
            this.menuGroup.setAttribute('visible', false);
            this.toggleClickable('.menu-item', false);

            if (sceneId === 2) {
                this.scene2Group.setAttribute('visible', true);
                this.toggleClickable('.scene2-ui', true);
                this.goToYear(1); // Démarre en 2015
            } 
            else if (sceneId === 3) {
                this.scene3Group.setAttribute('visible', true);
                // Relancer l'animation du puzzle (astuce : on cache/affiche le container)
                // Note : Pour une vraie réinitialisation propre, il faudrait recréer les boîtes, 
                // mais ici l'animation se joue au chargement initial ou reload page.
                
                this.toggleClickable('.scene3-ui', true);
                this.toggleClickable('.scene3-piece', true);
            }
        },

        // Logique Diaporama Scene 2
        goToYear: function(step) {
          this.scene2Step = step;
          this.year2015.setAttribute('visible', false);
          this.year2020.setAttribute('visible', false);
          this.year2025.setAttribute('visible', false);

          if (step === 1) this.year2015.setAttribute('visible', true);
          if (step === 2) this.year2020.setAttribute('visible', true);
          if (step === 3) this.year2025.setAttribute('visible', true);

          // Visibilité boutons Prev/Next
          if (step === 1) { this.s2BtnPrev.setAttribute('visible', false); this.s2BtnPrev.classList.remove('clickable'); }
          else { this.s2BtnPrev.setAttribute('visible', true); this.s2BtnPrev.classList.add('clickable'); }

          if (step === 3) { this.s2BtnNext.setAttribute('visible', false); this.s2BtnNext.classList.remove('clickable'); }
          else { this.s2BtnNext.setAttribute('visible', true); this.s2BtnNext.classList.add('clickable'); }
        },

        toggleClickable: function(className, isClickable) {
          let els = document.querySelectorAll(className);
          els.forEach(el => {
            if(isClickable) el.classList.add('clickable');
            else el.classList.remove('clickable');
          });
        }
      });

      // --- 4. NAVIGATION SIMPLE (SCÈNE 1) ---
      AFRAME.registerComponent('navigate-on-click', {
        schema: { url: {default: ''} },
        init: function () {
          var data = this.data;
          this.el.addEventListener('click', function () { window.location.href = data.url; });
        }
      });
    </script>
  </head>
  <body>
    <a-scene app-controller mindar-image="imageTargetSrc: card1.mind;" color-space="sRGB" renderer="colorManagement: true, physicallyCorrectLights" vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
      
      <a-assets>
        <img id="card" src="card1.jpg" />
        <img id="scene1-img" src="scenes/1.png" />
        <img id="scene2-img" src="scenes/2.png" />
        <img id="scene3-img" src="scenes/3.png" />
        <a-asset-item id="student-model" src="assets_scene2/mjo_character_student_school.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false" cursor="fuse: false; rayOrigin: mouse;" raycaster="far: 10000; objects: .clickable"></a-camera>

      <a-entity mindar-image-target="targetIndex: 0">
        
        <a-entity id="main-menu">
            <a-plane src="#card" position="0 0 0" height="0.552" width="1" rotation="0 0 0"></a-plane>
            
            <a-image class="clickable menu-item" src="#scene1-img" navigate-on-click="url: scene1.html"
                     position="-0.35 0 0.1" scale="0.25 0.25 0.25"
                     animation="property: position; to: -0.35 0.1 0.1; dur: 1000; dir: alternate; loop: true"></a-image>

            <a-image id="btn-launch-scene2" class="clickable menu-item" src="#scene2-img" 
                     position="0 0 0.1" scale="0.25 0.25 0.25"
                     animation="property: position; to: 0 0.1 0.1; dur: 1000; dir: alternate; loop: true"></a-image>

            <a-image id="btn-launch-scene3" class="clickable menu-item" src="#scene3-img" 
                     position="0.35 0 0.1" scale="0.25 0.25 0.25"
                     animation="property: position; to: 0.35 0.1 0.1; dur: 1000; dir: alternate; loop: true"></a-image>
        </a-entity>


        <a-entity id="scene2-container" visible="false" scale="0.05 0.05 0.05" rotation="0 0 0">
            <a-plane width="30" height="40" color="#111" position="0 5 -5"></a-plane>

            <a-entity id="year-2015" visible="false">
                <a-entity position="0 1 0" population-generator="count: 15; zStart: 0; zEnd: -10; widthSpread: 10; modelScale: 0.1 0.1 0.1" rotation="90 0 0"></a-entity>
                <a-text value="2015" position="0 -3 1" align="center" color="#FFF" scale="8 8 8"></a-text>
                <a-text value="78 Apprentis" position="0 -5 1" align="center" color="#aaa" scale="4 4 4"></a-text>
            </a-entity>

            <a-entity id="year-2020" visible="false">
                <a-entity position="0 1 0" population-generator="count: 60; zStart: 0; zEnd: -15; widthSpread: 12; modelScale: 0.1 0.1 0.1" rotation="90 0 0"></a-entity>
                <a-text value="2020" position="0 -3 1" align="center" color="#FFF" scale="8 8 8"></a-text>
                <a-text value="153 Apprentis" position="0 -5 1" align="center" color="#aaa" scale="4 4 4"></a-text>
            </a-entity>

            <a-entity id="year-2025" visible="false">
                <a-entity position="0 1 0" population-generator="count: 200; zStart: 0; zEnd: -20; widthSpread: 20; modelScale: 0.1 0.1 0.1" rotation="90 0 0"></a-entity>
                <a-text value="2025" position="0 -3 1" align="center" color="#F00" scale="10 10 10"></a-text>
                <a-text value="928 APPRENTIS !" position="0 -5 1" align="center" color="#F00" scale="5 5 5"></a-text>
            </a-entity>

            <a-plane id="s2-btn-prev" class="scene2-ui" position="-8 -10 2" width="5" height="2.5" color="#333">
                <a-text value="< RETOUR" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="s2-btn-next" class="scene2-ui" position="8 -10 2" width="5" height="2.5" color="#4CC3D9">
                <a-text value="SUIVANT >" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
            <a-plane id="s2-btn-close" class="scene2-ui" position="0 -10 2" width="6" height="2" color="#D7263D">
                <a-text value="Affiche" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>
        </a-entity>


        <a-entity id="scene3-container" visible="false" scale="0.05 0.05 0.05" rotation="0 0 0">
            
            <a-plane width="30" height="40" color="#2c3e50" position="0 5 -5"></a-plane>

            <a-text value="Le Puzzle des Filieres" position="0 15 1" align="center" color="#FFF" scale="6 6 6"></a-text>

            <a-entity position="0 4 0" puzzle-manager></a-entity>

            <a-plane id="s3-btn-close" class="scene3-ui" position="0 -10 2" width="6" height="2" color="#D7263D">
                <a-text value="Affiche" align="center" scale="3 3 3" position="0 0 0.1"></a-text>
            </a-plane>

        </a-entity>

      </a-entity>
    </a-scene>
  </body>
</html>